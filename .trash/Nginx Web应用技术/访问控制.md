Nginx 中提供了两个用于配置访问权限控制的关键字，分别为 allow 和 deny 。

关键字 allow 和 deny 后可接禁止的 IP 地址、IP 段或设置关键字 all。关键字 all 表示所有。

allow 和 deny 配置项可以在 http、server 以及 location 配置块中出现。

---

## 禁止所有用户访问

```shell
deny all;
```

当前配置块配置了拒绝所有访问时，所请求的连接全部会返回状态码 403，即无权访问。直接返回可能对用户不友好，可以通过[[定义错误页]]的方式处理这些错误。

```shell
server {
	...

	location =/index.html {
		deny all;
	}
	error_page 403 /403.html;

	...
}
```

需要注意的是当错误页所存在的根目录在 Nginx 配置中配置了拒绝所有，那么这个错误页将无法访问，错误页的配置将无效。

---

## 允许单个或多个 IP 地址访问

通过配置 allow 以允许指定 IP 地址访问。由于默认是允许所有 IP 地址访问，那么在 allow 语句的后面需要加上一条禁止所有用户访问的语句，即 `deny all;` 。

```text
allow 192.168.163.130;
allow 192.168.163.0;
deny all;
```

在配置过程中需要注意：
- 单个 IP 指定作用范围最小，all 指定作用范围最大。
- 同一块下，若同时存在多个权限指令（deny、allow），则先出现的访问权限设置生效，并且会对后出现的设置进行覆盖，未覆盖的范围依然生效，否则以先出现的设置为准。
这也是为什么在配置了 allow 语句后默认地加上一条 `deny all;` 。

在通过 allow 语句允许一个网络段时，可能是通过地址大类进行匹配。

---

## 嵌套的配置块间的匹配规则

server 配置块是定义在 http 配置块中的，location 配置块是定义在 server 配置块中的，这样就形成了嵌套的配置块。访问控制可以在这三个配置块中同时进行，那么他们是如何进行匹配的？

当多个块（如 http、server、location）中都出现了权限设置指令，则内层块中的权限级别要比外层块中设置的权限级别高。此时会出现这样一种情况：当内外层块中同时出现权限指令时，则内层块中的 `allow all;` 会覆盖外层块中的 `deny all;` 的设置。

```shell
http {
	...
	deny all;

	server {
		...
		allow all;

		location =/index.html {
			deny all;
		}
		...
	}
	...
}
```

上述配置文件生效后，若用户要访问 index.html 会遭到权限拒绝，但是访问其他文件则不会，尽管在 http 配置块中拒绝了所有用户，因为 server 配置块的优先级较高。